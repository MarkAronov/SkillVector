#!/usr/bin/env sh
. "$(dirname "$0")/_/husky.sh"

echo "[>>] Running comprehensive pre-push checks..."
echo ""

# 0. Generate OpenAPI spec
echo "→ [0/6] Generating OpenAPI spec..."
bun run generate:openapi || exit 1
echo "✓ OpenAPI spec generated"
echo ""

# 1. Linting & Formatting (catches code style issues)
echo "→ [1/7] Linting code..."
bun run check:backend || exit 1
bun run check:frontend || exit 1
echo "✓ Linting passed"
echo ""

# 2. Type Checking (catches type errors)
echo "→ [2/7] Type checking..."
bun run typecheck:backend || exit 1
bun run typecheck:frontend || exit 1
echo "✓ Type checking passed"
echo ""

# 3. Running Tests (catches logic bugs & runtime errors)
echo "→ [3/7] Running tests..."
bun run test || exit 1
echo "✓ Tests passed"
echo ""

if [ "$FULL_PRE_PUSH" = "1" ]; then

    # 4. Security Audits (catches vulnerabilities)
    echo "→ [4/7] Running security audits..."
    bun run audit:all || exit 1
    echo "✓ Security audits passed"
    echo ""

    # 5. Builds (catches build failures)
    echo "→ [5/7] Running builds..."
    bun run build:sdk || exit 1
    bun run build:frontend || exit 1
    bun run build:storybook || exit 1
    echo "✓ Builds passed"
    echo ""

    # 6. Docker Check (catches containerization issues)
    echo "→ [6/7] Verifying Docker build..."
    if docker info > /dev/null 2>&1; then
        TMP_IID_FILE="$(mktemp -t sv_iid.XXXXXX 2>/dev/null || echo /tmp/sv_iid.$$)"
        # Build and write the image id to a temp file so we can remove it later
        docker build . --file Dockerfile --iidfile "$TMP_IID_FILE" --force-rm --quiet > /dev/null || { echo "[ERROR] Docker build failed" >&2; rm -f "$TMP_IID_FILE"; exit 1; }
        IMAGE_ID="$(cat "$TMP_IID_FILE" 2>/dev/null || true)"
        if [ -n "$IMAGE_ID" ]; then
            # Remove the image we just created to avoid leaving local artifacts
            docker rmi "$IMAGE_ID" > /dev/null 2>&1 || echo "[WARN] Failed to remove Docker image $IMAGE_ID"
            echo "✓ Docker build passed and image removed"
        else
            echo "✓ Docker build passed (no image id found)"
        fi
        rm -f "$TMP_IID_FILE" || true
    else
        echo "[ERROR] Docker is not running. Aborting pre-push - start Docker and try again." >&2
        exit 1
    fi
    echo ""

    # 7. Nuclei Security Scan (catches security vulnerabilities)
    if [ "$SKIP_NUCLEI" != "1" ]; then
        echo "→ [7/7] Running Nuclei security scan..."
        if command -v nuclei > /dev/null 2>&1; then
            # Start app in background
            SKIP_STATIC_DATA=true bun run dev > /dev/null 2>&1 &
            APP_PID=$!
            
            # Wait for app to start (max 15 seconds)
            for i in {1..15}; do
                if curl -s http://localhost:3001/health > /dev/null 2>&1; then
                    break
                fi
                sleep 1
            done
            
            # Run nuclei with only high/critical severity custom templates
            nuclei -u http://localhost:3001 \
                -t security/nuclei-templates/ \
                -severity high,critical \
                -silent -no-color > /dev/null 2>&1
            NUCLEI_EXIT=$?
            
            # Stop the app
            kill $APP_PID 2>/dev/null || true
            wait $APP_PID 2>/dev/null || true
            
            if [ $NUCLEI_EXIT -ne 0 ]; then
                echo "[ERROR] Nuclei found security issues. Run 'bun run security:nuclei' for details." >&2
                exit 1
            fi
            echo "✓ Nuclei scan passed"
        else
            echo "[WARN] Nuclei not installed. Install: https://github.com/projectdiscovery/nuclei#install"
            echo "      macOS: brew install nuclei"
            echo "      Windows: choco install nuclei"
            echo "      Linux: https://github.com/projectdiscovery/nuclei/releases"
            echo "      To skip this check, use: SKIP_NUCLEI=1 git push"
        fi
        echo ""
    else
        echo "→ [7/7] Skipping Nuclei security scan (SKIP_NUCLEI=1)"
        echo ""
    fi

else
    echo "→ Skipping long pre-push checks (security audits, builds, Docker, nuclei)."
    echo "   To run full checks locally, use: FULL_PRE_PUSH=1 git push"
    echo ""
fi

echo "[OK] All pre-push checks passed! Safe to push."
